<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Raport Porównania - {{ document_pair.name }}</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
            @bottom-right {
                content: "Strona " counter(page) " z " counter(pages);
                font-size: 9pt;
                color: #595959;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DejaVu Sans', Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.4;
            color: #595959;
        }

        h1 {
            font-size: 18pt;
            color: #009597;
            margin-bottom: 10pt;
            padding-bottom: 5pt;
            border-bottom: 2pt solid #009597;
        }

        h2 {
            font-size: 14pt;
            color: #009597;
            margin-top: 15pt;
            margin-bottom: 8pt;
        }

        h3 {
            font-size: 11pt;
            color: #595959;
            font-weight: bold;
            margin-top: 10pt;
            margin-bottom: 5pt;
        }

        .header {
            background-color: #F2F2F2;
            padding: 10pt;
            margin-bottom: 15pt;
            border-left: 4pt solid #009597;
        }

        .header-grid {
            display: flex;
            justify-content: space-between;
            margin-top: 5pt;
        }

        .header-col {
            width: 48%;
        }

        .stats-grid {
            display: flex;
            justify-content: space-around;
            margin: 10pt 0;
            background-color: #F2F2F2;
            padding: 10pt;
            border-radius: 3pt;
        }

        .stat-box {
            text-align: center;
            padding: 5pt 10pt;
        }

        .stat-number {
            font-size: 16pt;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 8pt;
            color: #666;
            display: block;
            margin-top: 2pt;
        }

        .stat-added { color: #70A300; }
        .stat-removed { color: #ED1B2F; }
        .stat-modified { color: #FFA500; }
        .stat-moved { color: #009597; }
        .stat-unchanged { color: #999; }

        .change-item {
            margin-bottom: 8pt;
            padding: 8pt;
            border-radius: 3pt;
            page-break-inside: avoid;
        }

        .change-added {
            background-color: #e8f5e9;
            border-left: 3pt solid #70A300;
        }

        .change-removed {
            background-color: #ffebee;
            border-left: 3pt solid #ED1B2F;
        }

        .change-modified {
            background-color: #fff3e0;
            border-left: 3pt solid #FFA500;
        }

        .change-header {
            font-size: 8pt;
            color: #666;
            margin-bottom: 4pt;
        }

        .change-text {
            font-size: 9pt;
            line-height: 1.3;
        }

        .inline-diff {
            font-size: 9pt;
            line-height: 1.4;
            padding: 6pt;
            background-color: white;
            border-radius: 2pt;
            margin-top: 4pt;
        }

        .diff-removed {
            background-color: #ffcdd2;
            color: #c62828;
            text-decoration: line-through;
            padding: 1pt 2pt;
        }

        .diff-added {
            background-color: #c8e6c9;
            color: #2e7d32;
            font-weight: bold;
            padding: 1pt 2pt;
        }

        .ai-summary {
            background-color: #e3f2fd;
            padding: 10pt;
            margin: 10pt 0;
            border-left: 4pt solid #009597;
            border-radius: 3pt;
        }

        .severity-badge {
            display: inline-block;
            padding: 2pt 6pt;
            border-radius: 2pt;
            font-size: 8pt;
            font-weight: bold;
            color: white;
        }

        .severity-MAJOR { background-color: #ED1B2F; }
        .severity-MODERATE { background-color: #FFA500; }
        .severity-MINOR { background-color: #70A300; }

        .compliance-box {
            background-color: #fff9e6;
            padding: 8pt;
            margin: 8pt 0;
            border-left: 3pt solid #FFA500;
            border-radius: 2pt;
        }

        .impact-badge {
            display: inline-block;
            padding: 2pt 5pt;
            border-radius: 2pt;
            font-size: 8pt;
            font-weight: bold;
            margin-right: 5pt;
        }

        .impact-HIGH { background-color: #ED1B2F; color: white; }
        .impact-MEDIUM { background-color: #FFA500; color: white; }
        .impact-LOW { background-color: #70A300; color: white; }
        .impact-NONE { background-color: #999; color: white; }

        .metadata-row {
            font-size: 9pt;
            margin: 2pt 0;
        }

        .metadata-label {
            font-weight: bold;
            color: #666;
        }

        ul {
            margin: 5pt 0 5pt 15pt;
            font-size: 9pt;
        }

        li {
            margin: 2pt 0;
        }

        .section {
            margin-bottom: 12pt;
        }

        .no-data {
            color: #999;
            font-style: italic;
            padding: 10pt;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Raport Porównania Dokumentów</h1>

    <div class="header">
        <strong>Dokument:</strong> {{ document_pair.name }}<br>
        <strong>Data generowania:</strong> {{ generated_at.strftime("%Y-%m-%d %H:%M:%S") }}

        <div class="header-grid">
            <div class="header-col">
                <h3 style="margin-top: 8pt;">Stara Wersja</h3>
                <div class="metadata-row"><span class="metadata-label">Autor:</span> {{ old_meta.author or "N/A" }}</div>
                <div class="metadata-row"><span class="metadata-label">Data modyfikacji:</span> {{ old_meta.last_modified or "N/A" }}</div>
                <div class="metadata-row"><span class="metadata-label">Akapity:</span> {{ old_meta.paragraph_count }}</div>
            </div>
            <div class="header-col">
                <h3 style="margin-top: 8pt;">Nowa Wersja</h3>
                <div class="metadata-row"><span class="metadata-label">Autor:</span> {{ new_meta.author or "N/A" }}</div>
                <div class="metadata-row"><span class="metadata-label">Data modyfikacji:</span> {{ new_meta.last_modified or "N/A" }}</div>
                <div class="metadata-row"><span class="metadata-label">Akapity:</span> {{ new_meta.paragraph_count }}</div>
            </div>
        </div>
    </div>

    <h2>Statystyki Zmian</h2>
    <div class="stats-grid">
        <div class="stat-box">
            <span class="stat-number stat-added">{{ diff.statistics.added_count }}</span>
            <span class="stat-label">Dodane</span>
        </div>
        <div class="stat-box">
            <span class="stat-number stat-removed">{{ diff.statistics.removed_count }}</span>
            <span class="stat-label">Usunięte</span>
        </div>
        <div class="stat-box">
            <span class="stat-number stat-modified">{{ diff.statistics.modified_count }}</span>
            <span class="stat-label">Zmodyfikowane</span>
        </div>
        <div class="stat-box">
            <span class="stat-number stat-moved">{{ diff.statistics.moved_count }}</span>
            <span class="stat-label">Przesunięte</span>
        </div>
        <div class="stat-box">
            <span class="stat-number stat-unchanged">{{ diff.statistics.unchanged_count }}</span>
            <span class="stat-label">Bez zmian</span>
        </div>
    </div>

    {% if has_ai and ai_analysis %}
    <div class="ai-summary section">
        <h3>Analiza AI</h3>
        <p style="margin-top: 5pt;">{{ ai_analysis.overall_summary }}</p>
    </div>

    {% if ai_analysis.compliance_report %}
    <div class="compliance-box section">
        <h3>Compliance - Poziom ryzyka:
            <span class="impact-badge impact-{{ ai_analysis.compliance_report.overall_risk.value }}">
                {{ ai_analysis.compliance_report.overall_risk.value }}
            </span>
        </h3>
        <p style="margin-top: 5pt; font-size: 9pt;">{{ ai_analysis.compliance_report.summary }}</p>

        {% for impact in ai_analysis.compliance_report.impacts %}
        <div style="margin-top: 8pt; padding-left: 10pt;">
            <strong>{{ impact.regulation }}:</strong>
            <span class="impact-badge impact-{{ impact.impact_level.value }}">{{ impact.impact_level.value }}</span>

            {% if impact.potential_issues %}
            <ul style="margin-top: 3pt;">
                {% for issue in impact.potential_issues[:2] %}
                <li>{{ issue }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endif %}

    {% if diff.modified_paragraphs %}
    <h2>Zmodyfikowane Akapity ({{ diff.modified_paragraphs | length }})</h2>
    <div class="section">
        {% for mod in diff.modified_paragraphs %}
        <div class="change-item change-modified">
            <div class="change-header">Pozycja {{ mod.index }}</div>

            {% if has_ai and ai_analysis %}
                {% set matching_analysis = ai_analysis.change_analyses | selectattr('old_text', 'eq', mod.old_text[:200]) | first %}
                {% if matching_analysis %}
                <div style="margin-bottom: 4pt;">
                    <span class="severity-badge severity-{{ matching_analysis.severity.value }}">
                        {{ matching_analysis.severity.value }}
                    </span>
                    <span style="font-size: 9pt; margin-left: 5pt;">{{ matching_analysis.summary }}</span>
                </div>
                {% endif %}
            {% endif %}

            <div class="inline-diff">
                {% for operation, text in mod.changes %}
                    {% if operation == -1 %}
                        <span class="diff-removed">{{ text }}</span>
                    {% elif operation == 1 %}
                        <span class="diff-added">{{ text }}</span>
                    {% else %}
                        <span>{{ text }}</span>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if diff.added_paragraphs %}
    <h2>Dodane Akapity ({{ diff.added_paragraphs | length }})</h2>
    <div class="section">
        {% for idx, text in diff.added_paragraphs %}
        <div class="change-item change-added">
            <div class="change-header">Pozycja {{ idx }}</div>
            <div class="change-text">{{ text }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if diff.removed_paragraphs %}
    <h2>Usunięte Akapity ({{ diff.removed_paragraphs | length }})</h2>
    <div class="section">
        {% for idx, text in diff.removed_paragraphs %}
        <div class="change-item change-removed">
            <div class="change-header">Pozycja {{ idx }}</div>
            <div class="change-text">{{ text }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if diff.moved_paragraphs %}
    <h2>Przesunięte Akapity ({{ diff.moved_paragraphs | length }})</h2>
    <div class="section">
        {% for moved in diff.moved_paragraphs %}
        <div class="change-item" style="background-color: #e1f5fe; border-left: 3pt solid #009597;">
            <div class="change-header">Z pozycji {{ moved.old_index }} na {{ moved.new_index }}</div>
            <div class="change-text">{{ moved.text }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if table_diff.statistics.added_rows > 0 or table_diff.statistics.removed_rows > 0 or table_diff.statistics.modified_cells > 0 %}
    <h2>Zmiany w Tabelach</h2>
    <div class="stats-grid">
        <div class="stat-box">
            <span class="stat-number stat-added">{{ table_diff.statistics.added_rows }}</span>
            <span class="stat-label">Dodane wiersze</span>
        </div>
        <div class="stat-box">
            <span class="stat-number stat-removed">{{ table_diff.statistics.removed_rows }}</span>
            <span class="stat-label">Usunięte wiersze</span>
        </div>
        <div class="stat-box">
            <span class="stat-number stat-modified">{{ table_diff.statistics.modified_cells }}</span>
            <span class="stat-label">Zmienione komórki</span>
        </div>
    </div>
    {% endif %}
</body>
</html>
